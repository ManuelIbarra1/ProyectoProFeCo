<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROFECO - Dashboard Consumidor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .navbar-brand {
            font-weight: bold;
            color: #1a237e !important;
        }
        .sidebar {
            background: #f8f9fa;
            min-height: calc(100vh - 56px);
            border-right: 1px solid #dee2e6;
        }
        .sidebar-sticky {
            position: sticky;
            top: 0;
            height: calc(100vh - 56px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .sidebar .nav-link {
            padding: 0.75rem 1rem;
            color: #495057;
            border-radius: 0.375rem;
            margin: 0.125rem 0.5rem;
        }
        .sidebar .nav-link:hover {
            background: #e9ecef;
            color: #1a237e;
        }
        .sidebar .nav-link.active {
            background: #1a237e;
            color: white;
            font-weight: 500;
        }
        .stat-card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
        }
        .btn-action {
            padding: 0.5rem 1.5rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check me-2"></i>PROFECO
            </a>
            <div class="d-flex align-items-center">
                <span id="user-info-nav" class="me-3"></span>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="sidebar-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-speedometer2 me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="crear-queja.html">
                                <i class="bi bi-plus-circle me-2"></i> Nueva Queja
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="mis-quejas.html">
                                <i class="bi bi-list-check me-2"></i> Mis Quejas
                                <span class="badge bg-primary float-end mt-1" id="quejas-badge">0</span>
                            </a>
                        </li>
                        
                    </ul>
                    
                    
                </div>
            </div>
            
            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <!-- Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-house-door me-2"></i>Dashboard
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button class="btn btn-primary me-2" onclick="window.location.href='crear-queja.html'">
                            <i class="bi bi-plus-circle me-1"></i> Nueva Queja
                        </button>
                        <button class="btn btn-outline-secondary" onclick="window.location.href='mis-quejas.html'">
                            <i class="bi bi-list-check me-1"></i> Ver Todas
                        </button>
                    </div>
                </div>
                
                <!-- Mensaje de bienvenida -->
                <div class="alert alert-light border" id="welcome-message">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle-fill text-primary me-3 fs-4"></i>
                        <div>
                            <h5 class="alert-heading mb-1" id="welcome-title">Bienvenido al Sistema PROFECO</h5>
                            <p class="mb-0" id="welcome-text">Aqu√≠ puedes registrar y gestionar tus quejas</p>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card text-white bg-primary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-subtitle mb-2 opacity-75">Total Quejas</h6>
                                        <h2 class="card-title mb-0" id="total-quejas">0</h2>
                                    </div>
                                    <i class="bi bi-clipboard-check fs-2 opacity-75"></i>
                                </div>
                                <p class="card-text small mt-2 opacity-75">
                                    <i class="bi bi-arrow-up-circle me-1"></i>
                                    <span id="quejas-trend">0 este mes</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card text-white bg-success">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-subtitle mb-2 opacity-75">Resueltas</h6>
                                        <h2 class="card-title mb-0" id="quejas-resueltas">0</h2>
                                    </div>
                                    <i class="bi bi-check-circle fs-2 opacity-75"></i>
                                </div>
                                <p class="card-text small mt-2 opacity-75">
                                    <i class="bi bi-graph-up me-1"></i>
                                    75% de efectividad
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card text-white bg-warning">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-subtitle mb-2 opacity-75">En Proceso</h6>
                                        <h2 class="card-title mb-0" id="quejas-proceso">0</h2>
                                    </div>
                                    <i class="bi bi-hourglass-split fs-2 opacity-75"></i>
                                </div>
                                <p class="card-text small mt-2 opacity-75">
                                    <i class="bi bi-clock-history me-1"></i>
                                    Promedio: 5 d√≠as
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    
                </div>
                
                <!-- Quick Actions & Recent Quejas -->
                <div class="row">
                    <!-- Quejas Recientes -->
                    <div class="col-lg-8 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-clock-history me-2"></i> Quejas Recientes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th># Folio</th>
                                                <th>Empresa</th>
                                                <th>Fecha</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-quejas">
                                            <tr>
                                                <td colspan="5" class="text-center py-5">
                                                    <div class="text-muted">
                                                        <i class="bi bi-inbox fs-1"></i>
                                                        <p class="mt-2">No hay quejas recientes</p>
                                                        <button class="btn btn-primary btn-sm mt-2" onclick="window.location.href='crear-queja.html'">
                                                            Crear primera queja
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Acciones R√°pidas -->
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-lightning me-2"></i> Acciones R√°pidas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-action" onclick="window.location.href='crear-queja.html'">
                                        <i class="bi bi-plus-circle me-2"></i> Nueva Queja
                                    </button>
                                    <button class="btn btn-outline-primary btn-action" onclick="window.location.href='mis-quejas.html'">
                                        <i class="bi bi-list-check me-2"></i> Ver Todas Mis Quejas
                                    </button>
                                    
                                </div>
                                
                                
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tips Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-lightbulb text-warning me-2"></i>
                                    <h5 class="mb-0">Consejos para Consumidores</h5>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card border-0 bg-white mb-3">
                                            <div class="card-body">
                                                <h6><i class="bi bi-receipt me-2"></i>Guarda tus tickets</h6>
                                                <p class="small text-muted mb-0">Conserva siempre los comprobantes de compra.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-0 bg-white mb-3">
                                            <div class="card-body">
                                                <h6><i class="bi bi-chat-text me-2"></i>Comunica primero</h6>
                                                <p class="small text-muted mb-0">Intenta resolver directamente con la empresa.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-0 bg-white mb-3">
                                            <div class="card-body">
                                                <h6><i class="bi bi-clock me-2"></i>S√© puntual</h6>
                                                <p class="small text-muted mb-0">Presenta tu queja dentro de los 30 d√≠as.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ===== VERIFICACI√ìN DE AUTENTICACI√ìN Y ROL =====
            if (!window.authService) {
                console.error('authService no est√° disponible');
                window.location.href = 'login.html';
                return;
            }
            
            if (!window.authService.isAuthenticated()) {
                console.warn('Usuario no autenticado, redirigiendo...');
                window.location.href = 'login.html';
                return;
            }
            
            const user = window.authService.getCurrentUser();
            
            if (!user) {
                console.error('No se pudo obtener informaci√≥n del usuario');
                window.authService.logout();
                return;
            }
            
            if (!window.authService.isConsumer()) {
                console.warn(`Usuario con rol ${user.rol} intentando acceder a dashboard de consumidor`);
                
                if (window.authService.isAdmin()) {
                    window.location.href = 'dashboard-profeco.html';
                } else {
                    window.location.href = 'login.html';
                }
                return;
            }
            
            // ===== INICIALIZACI√ìN DEL DASHBOARD =====
            const displayName = user.nombre || user.usuario || user.correo || 'Usuario';
            
            // Navbar
            document.getElementById('user-info-nav').innerHTML = `
                <i class="bi bi-person-circle me-1"></i> ${displayName}
                <span class="badge bg-success">consumidor</span>
            `;
            
            // Mensaje de bienvenida
            document.getElementById('welcome-title').textContent = `Bienvenido, ${displayName}`;
            document.getElementById('welcome-text').textContent = 'Aqu√≠ puedes registrar y gestionar tus quejas como consumidor';
            
            // Cargar datos reales del consumidor
            loadConsumerData();
            
            // Actualizar cada 30 segundos
            setInterval(loadConsumerData, 30000);
        });
        
        async function loadConsumerData() {
            try {
                const user = authService.getCurrentUser();
                const usuario = user.usuario || user.correo;
                
                console.log('üë§ Usuario actual:', usuario);
                
                // Obtener quejas del usuario
                const response = await authService.authenticatedFetch(`/api/quejas`);
                
                console.log('üì• Respuesta del backend:', response);
                
                if (response && response.quejas) {
                    // Filtrar solo las quejas del usuario actual
                    const quejasUsuario = response.quejas.filter(q => q.usuario === usuario);
                    console.log('‚úÖ Quejas del usuario:', quejasUsuario);
                    
                    const totalQuejas = quejasUsuario.length;
                    const quejasResueltas = quejasUsuario.filter(q => q.estado === 'RESUELTA').length;
                    const quejasProceso = quejasUsuario.filter(q => q.estado === 'EN_PROCESO').length;
                    
                    // Actualizar estad√≠sticas
                    document.getElementById('total-quejas').textContent = totalQuejas;
                    document.getElementById('quejas-resueltas').textContent = quejasResueltas;
                    document.getElementById('quejas-proceso').textContent = quejasProceso;
                    document.getElementById('quejas-badge').textContent = quejasProceso;
                    
                    // Actualizar tendencia (quejas de este mes)
                    const ahora = new Date();
                    const quejasEsteMes = quejasUsuario.filter(q => {
                        const fechaQueja = new Date(q.fecha);
                        return fechaQueja.getMonth() === ahora.getMonth() && 
                               fechaQueja.getFullYear() === ahora.getFullYear();
                    }).length;
                    
                    document.getElementById('quejas-trend').textContent = `${quejasEsteMes} este mes`;
                    
                    // Actualizar quejas recientes
                    mostrarQuejasRecientes(quejasUsuario.slice(0, 5));
                } else {
                    console.warn('‚ö†Ô∏è Respuesta no tiene el formato esperado:', response);
                }
            } catch (error) {
                console.error('‚ùå Error al cargar datos:', error);
                
                // Intentar con el endpoint espec√≠fico para usuario si el general falla
                try {
                    console.log('üîÑ Intentando con endpoint espec√≠fico de usuario...');
                    const user = authService.getCurrentUser();
                    const usuario = user.usuario || user.correo;
                    const response = await authService.authenticatedFetch(`/api/quejas/usuario/${usuario}`);
                    
                    if (response && response.quejas) {
                        const quejas = response.quejas;
                        const totalQuejas = quejas.length;
                        const quejasResueltas = quejas.filter(q => q.estado === 'RESUELTA').length;
                        const quejasProceso = quejas.filter(q => q.estado === 'EN_PROCESO').length;
                        
                        document.getElementById('total-quejas').textContent = totalQuejas;
                        document.getElementById('quejas-resueltas').textContent = quejasResueltas;
                        document.getElementById('quejas-proceso').textContent = quejasProceso;
                        document.getElementById('quejas-badge').textContent = quejasProceso;
                        
                        mostrarQuejasRecientes(quejas.slice(0, 5));
                    }
                } catch (error2) {
                    console.error('‚ùå Error con endpoint espec√≠fico:', error2);
                    // Mantener datos por defecto si hay error
                }
            }
        }
        
        function mostrarQuejasRecientes(quejas) {
            const tbody = document.getElementById('recent-quejas');
            
            if (quejas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">No hay quejas recientes</p>
                                <button class="btn btn-primary btn-sm mt-2" onclick="window.location.href='crear-queja.html'">
                                    Crear primera queja
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            quejas.forEach(queja => {
                const fecha = new Date(queja.fecha).toLocaleDateString('es-MX');
                const estadoClass = getEstadoClass(queja.estado);
                const estadoText = getEstadoText(queja.estado);
                
                html += `
                    <tr>
                        <td><strong>${queja.quejaId || 'N/A'}</strong></td>
                        <td>${queja.comercio || 'Sin comercio'}</td>
                        <td>${fecha}</td>
                        <td><span class="badge ${estadoClass}">${estadoText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="verDetallesQueja('${queja.quejaId}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function getEstadoClass(estado) {
            switch(estado?.toUpperCase()) {
                case 'RECIBIDA': return 'bg-info';
                case 'EN_PROCESO': return 'bg-warning';
                case 'RESUELTA': return 'bg-success';
                case 'CERRADA': return 'bg-secondary';
                default: return 'bg-light text-dark';
            }
        }
        
        function getEstadoText(estado) {
            switch(estado?.toUpperCase()) {
                case 'RECIBIDA': return 'Recibida';
                case 'EN_PROCESO': return 'En Proceso';
                case 'RESUELTA': return 'Resuelta';
                case 'CERRADA': return 'Cerrada';
                default: return estado || 'Desconocido';
            }
        }
        
        function verDetallesQueja(quejaId) {
            window.location.href = `mis-quejas.html?queja=${quejaId}`;
        }
        
        function logout() {
            if (window.authService) {
                if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
                    window.authService.logout();
                }
            } else {
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>