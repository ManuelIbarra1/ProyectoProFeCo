<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>PROFECO - Mis Quejas</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
        <style>
            :root {
                --profeco-blue: #1a237e;
                --profeco-red: #d32f2f;
            }

            .navbar-brand {
                font-weight: bold;
                color: var(--profeco-blue) !important;
            }

            .card {
                border-radius: 10px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            }

            .btn-primary {
                background-color: var(--profeco-blue);
                border-color: var(--profeco-blue);
            }

            .badge-estado {
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 0.85rem;
            }

            .badge-recibida {
                background-color: #17a2b8;
                color: white;
            }
            .badge-en-proceso {
                background-color: #ffc107;
                color: black;
            }
            .badge-resuelta {
                background-color: #28a745;
                color: white;
            }
            .badge-cerrada {
                background-color: #6c757d;
                color: white;
            }

            .queja-card:hover {
                transform: translateY(-2px);
                transition: transform 0.3s ease;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

            .filter-badge {
                cursor: pointer;
            }

            .empty-state {
                padding: 60px 20px;
                text-align: center;
                color: #6c757d;
            }

            .empty-state i {
                font-size: 4rem;
                margin-bottom: 20px;
                opacity: 0.5;
            }
        </style>
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="dashboard-consumidor.html">
                    <i class="bi bi-shield-check me-2"></i>PROFECO - Mis Quejas
                </a>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userDropdown" 
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-2"></i>
                            <span id="user-name-nav"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="dashboard-consumidor.html">
                                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                                </a></li>
                            <li><a class="dropdown-item" href="crear-queja.html">
                                    <i class="bi bi-plus-circle me-2"></i>Nueva Queja
                                </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                                    <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesi√≥n
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <div class="container-fluid py-4">
            <div class="row">
                <!-- Sidebar de Filtros -->
                <div class="col-lg-3 mb-4">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="bi bi-funnel me-2"></i>Filtros
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Filtro por Estado -->
                            <div class="mb-4">
                                <h6 class="mb-3">Estado</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge filter-badge badge-recibida" data-estado="RECIBIDA">
                                        Recibidas <span id="count-recibida" class="badge bg-light text-dark">0</span>
                                    </span>
                                    <span class="badge filter-badge badge-en-proceso" data-estado="EN_PROCESO">
                                        En Proceso <span id="count-proceso" class="badge bg-light text-dark">0</span>
                                    </span>
                                    <span class="badge filter-badge badge-resuelta" data-estado="RESUELTA">
                                        Resueltas <span id="count-resuelta" class="badge bg-light text-dark">0</span>
                                    </span>
                                    <span class="badge filter-badge badge-cerrada" data-estado="CERRADA">
                                        Cerradas <span id="count-cerrada" class="badge bg-light text-dark">0</span>
                                    </span>
                                </div>
                            </div>

                            <!-- Filtro por Comercio -->
                            <div class="mb-4">
                                <h6 class="mb-3">Comercio</h6>
                                <div id="comercios-list">
                                    <!-- Se llena din√°micamente -->
                                </div>
                            </div>

                            <!-- Filtro por Fecha -->
                            <div class="mb-4">
                                <h6 class="mb-3">Fecha</h6>
                                <select class="form-select" id="filtro-fecha">
                                    <option value="all">Todas las fechas</option>
                                    <option value="today">Hoy</option>
                                    <option value="week">Esta semana</option>
                                    <option value="month">Este mes</option>
                                    <option value="last-month">Mes pasado</option>
                                </select>
                            </div>

                            <!-- Estad√≠sticas -->
                            <div class="mt-4 pt-3 border-top">
                                <h6 class="mb-3">Estad√≠sticas</h6>
                                <div class="mb-2">
                                    <small class="text-muted">Total de Quejas:</small>
                                    <h4 id="total-quejas" class="mb-0">0</h4>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Resoluci√≥n:</small>
                                    <div class="progress" style="height: 10px;">
                                        <div id="resolucion-progress" class="progress-bar bg-success" style="width: 0%"></div>
                                    </div>
                                    <small id="resolucion-text" class="text-muted">0% resueltas</small>
                                </div>
                            </div>

                            <!-- Bot√≥n Limpiar Filtros -->
                            <button id="limpiar-filtros" class="btn btn-outline-secondary w-100 mt-3">
                                <i class="bi bi-x-circle me-2"></i>Limpiar Filtros
                            </button>
                        </div>
                    </div>

                    <!-- Acciones R√°pidas -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6 class="mb-3">Acciones R√°pidas</h6>
                            <a href="crear-queja.html" class="btn btn-primary w-100 mb-2">
                                <i class="bi bi-plus-circle me-2"></i>Nueva Queja
                            </a>
                            <button id="descargar-reporte" class="btn btn-outline-primary w-100">
                                <i class="bi bi-download me-2"></i>Descargar Reporte
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista de Quejas -->
                <div class="col-lg-9">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="mb-0">
                                <i class="bi bi-list-check me-2"></i>Mis Quejas
                            </h4>
                            <p class="text-muted mb-0" id="quejas-summary">Cargando quejas...</p>
                        </div>
                        <div class="d-flex">
                            <div class="input-group me-2" style="width: 300px;">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="search-input" 
                                       placeholder="Buscar por t√≠tulo, comercio...">
                            </div>
                            <button id="refresh-btn" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Alertas -->
                    <div id="alert-container"></div>

                    <!-- Contador de Resultados -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-light text-dark" id="result-count">0 quejas</span>
                        </div>
                        <div>
                            <select class="form-select form-select-sm" id="sort-select" style="width: auto;">
                                <option value="fecha-desc">M√°s recientes primero</option>
                                <option value="fecha-asc">M√°s antiguas primero</option>
                                <option value="titulo">Por t√≠tulo (A-Z)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Lista de Quejas -->
                    <div id="quejas-container">
                        <!-- Se llena din√°micamente -->
                    </div>

                    <!-- Estado Vac√≠o -->
                    <div id="empty-state" class="empty-state d-none">
                        <i class="bi bi-inbox"></i>
                        <h4 class="mb-3">No hay quejas para mostrar</h4>
                        <p class="mb-4">Parece que a√∫n no has registrado ninguna queja.</p>
                        <a href="crear-queja.html" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle me-2"></i>Crear Primera Queja
                        </a>
                    </div>

                    <!-- Paginaci√≥n -->
                    <nav id="pagination" class="d-none mt-4">
                        <ul class="pagination justify-content-center">
                            <!-- Se llena din√°micamente -->
                        </ul>
                    </nav>

                    <!-- Cargando -->
                    <div id="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3">Cargando quejas...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Detalles de Queja -->
        <div class="modal fade" id="quejaModal" tabindex="-1" aria-labelledby="quejaModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="quejaModalLabel">Detalles de la Queja</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="queja-modal-body">
                        <!-- Se llena din√°micamente -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" onclick="imprimirQueja()">
                            <i class="bi bi-printer me-2"></i>Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="js/auth.js"></script>
        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                // ===== VERIFICACI√ìN DE AUTENTICACI√ìN Y ROL =====
                                if (!window.authService || !window.authService.isAuthenticated()) {
                                    window.location.href = 'login.html';
                                    return;
                                }

                                const user = authService.getCurrentUser();
                                if (!user || !authService.isConsumer()) {
                                    window.location.href = 'login.html';
                                    return;
                                }

                                // Mostrar nombre del usuario
                                const displayName = user.nombre || user.usuario || user.correo || 'Usuario';
                                document.getElementById('user-name-nav').textContent = displayName;

                                // Variables globales
                                let todasLasQuejas = [];
                                let quejasFiltradas = [];
                                let filtrosActivos = {
                                    estado: null,
                                    comercio: null,
                                    fecha: 'all',
                                    busqueda: ''
                                };
                                const itemsPorPagina = 10;
                                let paginaActual = 1;

                                // ===== INICIALIZACI√ìN =====
                                cargarQuejas();

                                // ===== EVENT LISTENERS =====

                                // Filtros por estado
                                document.querySelectorAll('.filter-badge[data-estado]').forEach(badge => {
                                    badge.addEventListener('click', function () {
                                        const estado = this.getAttribute('data-estado');
                                        if (filtrosActivos.estado === estado) {
                                            filtrosActivos.estado = null;
                                            this.classList.remove('active');
                                        } else {
                                            filtrosActivos.estado = estado;
                                            document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
                                            this.classList.add('active');
                                        }
                                        aplicarFiltros();
                                    });
                                });

                                // Filtro por fecha
                                document.getElementById('filtro-fecha').addEventListener('change', function () {
                                    filtrosActivos.fecha = this.value;
                                    aplicarFiltros();
                                });

                                // B√∫squeda
                                document.getElementById('search-input').addEventListener('input', function () {
                                    filtrosActivos.busqueda = this.value.toLowerCase();
                                    aplicarFiltros();
                                });

                                // Ordenamiento
                                document.getElementById('sort-select').addEventListener('change', function () {
                                    aplicarFiltros();
                                });

                                // Limpiar filtros
                                document.getElementById('limpiar-filtros').addEventListener('click', function () {
                                    filtrosActivos = {
                                        estado: null,
                                        comercio: null,
                                        fecha: 'all',
                                        busqueda: ''
                                    };

                                    document.getElementById('filtro-fecha').value = 'all';
                                    document.getElementById('search-input').value = '';
                                    document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
                                    document.querySelectorAll('.filter-comercio').forEach(c => c.classList.remove('active'));

                                    aplicarFiltros();
                                });

                                // Refrescar
                                document.getElementById('refresh-btn').addEventListener('click', cargarQuejas);

                                // Descargar reporte
                                document.getElementById('descargar-reporte').addEventListener('click', descargarReporte);

                                // ===== FUNCIONES PRINCIPALES =====

                                async function cargarQuejas() {
                                    try {
                                        mostrarLoading(true);

                                        // Obtener quejas del usuario actual
                                        const user = authService.getCurrentUser();
                                        const usuario = user.usuario || user.correo;
                                        console.log('üë§ Obteniendo quejas para:', usuario);

                                        // Intentar primero con el endpoint general y filtrar
                                        const response = await authService.authenticatedFetch(`/api/quejas`);
                                        console.log('üì• Todas las quejas:', response);

                                        if (response && response.quejas) {
                                            // Filtrar solo las quejas del usuario actual
                                            todasLasQuejas = response.quejas.filter(q => q.usuario === usuario);
                                            console.log('‚úÖ Quejas del usuario:', todasLasQuejas);

                                            actualizarEstadisticas();
                                            aplicarFiltros();
                                        } else {
                                            throw new Error('Formato de respuesta inv√°lido');
                                        }

                                    } catch (error) {
                                        console.error('‚ùå Error al cargar quejas:', error);

                                        // Intentar con endpoint espec√≠fico si el general falla
                                        try {
                                            console.log('üîÑ Intentando con endpoint espec√≠fico...');
                                            const user = authService.getCurrentUser();
                                            const usuario = user.usuario || user.correo;
                                            const response = await authService.authenticatedFetch(`/api/quejas/usuario/${usuario}`);

                                            if (response && response.quejas) {
                                                todasLasQuejas = response.quejas;
                                                actualizarEstadisticas();
                                                aplicarFiltros();
                                            } else {
                                                mostrarError('No se pudieron cargar las quejas. ' + error.message);
                                                todasLasQuejas = [];
                                                mostrarQuejas([]);
                                            }
                                        } catch (error2) {
                                            console.error('‚ùå Error con endpoint espec√≠fico:', error2);
                                            mostrarError('No se pudieron cargar las quejas. ' + error2.message);
                                            todasLasQuejas = [];
                                            mostrarQuejas([]);
                                        }
                                    } finally {
                                        mostrarLoading(false);
                                    }
                                }

                                function aplicarFiltros() {
                                    // Aplicar todos los filtros
                                    quejasFiltradas = todasLasQuejas.filter(queja => {
                                        // Filtro por estado
                                        if (filtrosActivos.estado && queja.estado !== filtrosActivos.estado) {
                                            return false;
                                        }

                                        // Filtro por comercio
                                        if (filtrosActivos.comercio && queja.comercio !== filtrosActivos.comercio) {
                                            return false;
                                        }

                                        // Filtro por fecha
                                        if (filtrosActivos.fecha !== 'all') {
                                            const fechaQueja = new Date(queja.fecha);
                                            const hoy = new Date();

                                            switch (filtrosActivos.fecha) {
                                                case 'today':
                                                    if (!esMismoDia(fechaQueja, hoy))
                                                        return false;
                                                    break;
                                                case 'week':
                                                    if (!esMismaSemana(fechaQueja, hoy))
                                                        return false;
                                                    break;
                                                case 'month':
                                                    if (fechaQueja.getMonth() !== hoy.getMonth() ||
                                                            fechaQueja.getFullYear() !== hoy.getFullYear())
                                                        return false;
                                                    break;
                                                case 'last-month':
                                                    const mesPasado = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                                                    if (fechaQueja < mesPasado || fechaQueja.getMonth() !== mesPasado.getMonth())
                                                        return false;
                                                    break;
                                            }
                                        }

                                        // Filtro por b√∫squeda
                                        if (filtrosActivos.busqueda) {
                                            const busqueda = filtrosActivos.busqueda.toLowerCase();
                                            const titulo = queja.titulo ? queja.titulo.toLowerCase() : '';
                                            const descripcion = queja.descripcion ? queja.descripcion.toLowerCase() : '';
                                            const comercio = queja.comercio ? queja.comercio.toLowerCase() : '';
                                            const quejaId = queja.quejaId ? queja.quejaId.toLowerCase() : '';

                                            if (!titulo.includes(busqueda) &&
                                                    !descripcion.includes(busqueda) &&
                                                    !comercio.includes(busqueda) &&
                                                    !quejaId.includes(busqueda)) {
                                                return false;
                                            }
                                        }

                                        return true;
                                    });

                                    // Aplicar ordenamiento
                                    const sortValue = document.getElementById('sort-select').value;
                                    quejasFiltradas.sort((a, b) => {
                                        switch (sortValue) {
                                            case 'fecha-desc':
                                                return new Date(b.fecha) - new Date(a.fecha);
                                            case 'fecha-asc':
                                                return new Date(a.fecha) - new Date(b.fecha);
                                            case 'titulo':
                                                return (a.titulo || '').localeCompare(b.titulo || '');
                                            default:
                                                return 0;
                                        }
                                    });

                                    // Mostrar resultados
                                    mostrarQuejas(quejasFiltradas);
                                    actualizarContadores();
                                }

                                function mostrarQuejas(quejas) {
                                    const container = document.getElementById('quejas-container');
                                    const emptyState = document.getElementById('empty-state');
                                    const pagination = document.getElementById('pagination');

                                    if (quejas.length === 0) {
                                        container.innerHTML = '';
                                        emptyState.classList.remove('d-none');
                                        pagination.classList.add('d-none');
                                        return;
                                    }

                                    emptyState.classList.add('d-none');

                                    // Calcular paginaci√≥n
                                    const totalPaginas = Math.ceil(quejas.length / itemsPorPagina);
                                    const inicio = (paginaActual - 1) * itemsPorPagina;
                                    const fin = inicio + itemsPorPagina;
                                    const quejasPagina = quejas.slice(inicio, fin);

                                    // Mostrar quejas de la p√°gina actual
                                    container.innerHTML = quejasPagina.map(queja => crearCardQueja(queja)).join('');

                                    // Mostrar paginaci√≥n si hay m√°s de una p√°gina
                                    if (totalPaginas > 1) {
                                        crearPaginacion(totalPaginas);
                                        pagination.classList.remove('d-none');
                                    } else {
                                        pagination.classList.add('d-none');
                                    }

                                    // Actualizar contador de resultados
                                    document.getElementById('result-count').textContent =
                                            `${quejas.length} queja${quejas.length !== 1 ? 's' : ''}`;

                                    // Agregar event listeners a los botones de detalles
                                    document.querySelectorAll('.btn-ver-detalles').forEach(btn => {
                                        btn.addEventListener('click', function () {
                                            const quejaId = this.getAttribute('data-queja-id');
                                            mostrarDetallesQueja(quejaId);
                                        });
                                    });
                                }

                                function crearCardQueja(queja) {
                                    const fecha = new Date(queja.fecha).toLocaleDateString('es-MX', {
                                        year: 'numeric',
                                        month: 'short',
                                        day: 'numeric'
                                    });

                                    const estadoClass = getEstadoClass(queja.estado);
                                    const estadoText = getEstadoText(queja.estado);

                                    // Limitar descripci√≥n
                                    const descripcionCorta = queja.descripcion
                                            ? (queja.descripcion.length > 150
                                                    ? queja.descripcion.substring(0, 150) + '...'
                                                    : queja.descripcion)
                                            : 'Sin descripci√≥n';

                                    return `
                        <div class="card mb-3 queja-card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-start mb-2">
                                            <div class="me-3">
                                                <span class="badge-estado ${estadoClass}">${estadoText}</span>
                                            </div>
                                            <div>
                                                <h5 class="card-title mb-1">${queja.titulo || 'Sin t√≠tulo'}</h5>
                                                <div class="d-flex align-items-center mb-2">
                                                    <small class="text-muted me-3">
                                                        <i class="bi bi-building me-1"></i>${queja.comercio || 'Sin comercio'}
                                                    </small>
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar me-1"></i>${fecha}
                                                    </small>
                                                </div>
                                                <p class="card-text text-muted mb-2">${descripcionCorta}</p>
                                                <small class="text-muted">
                                                    <i class="bi bi-hash me-1"></i>${queja.quejaId || 'Sin folio'}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-outline-primary btn-sm me-2 btn-ver-detalles" 
                                                data-queja-id="${queja.quejaId}">
                                            <i class="bi bi-eye me-1"></i>Ver Detalles
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="seguimientoQueja('${queja.quejaId}')">
                                            <i class="bi bi-clock-history me-1"></i>Seguimiento
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                                }

                                function crearPaginacion(totalPaginas) {
                                    const pagination = document.getElementById('pagination');
                                    let html = '';

                                    // Bot√≥n anterior
                                    html += `
                        <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="cambiarPagina(${paginaActual - 1})">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    `;

                                    // P√°ginas
                                    for (let i = 1; i <= totalPaginas; i++) {
                                        if (i === 1 || i === totalPaginas || (i >= paginaActual - 2 && i <= paginaActual + 2)) {
                                            html += `
                                <li class="page-item ${i === paginaActual ? 'active' : ''}">
                                    <a class="page-link" href="#" onclick="cambiarPagina(${i})">${i}</a>
                                </li>
                            `;
                                        } else if (i === paginaActual - 3 || i === paginaActual + 3) {
                                            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                                        }
                                    }

                                    // Bot√≥n siguiente
                                    html += `
                        <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="cambiarPagina(${paginaActual + 1})">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    `;

                                    pagination.querySelector('ul').innerHTML = html;
                                }

                                function cambiarPagina(pagina) {
                                    paginaActual = pagina;
                                    mostrarQuejas(quejasFiltradas);
                                    window.scrollTo({top: 0, behavior: 'smooth'});
                                }

                                async function mostrarDetallesQueja(quejaId) {
                                    try {
                                        const response = await authService.authenticatedFetch(`/api/quejas/${quejaId}`);

                                        if (response) {
                                            const modalBody = document.getElementById('queja-modal-body');
                                            const fecha = new Date(response.fecha).toLocaleDateString('es-MX', {
                                                year: 'numeric',
                                                month: 'long',
                                                day: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            });

                                            const estadoClass = getEstadoClass(response.estado);
                                            const estadoText = getEstadoText(response.estado);

                                            modalBody.innerHTML = `
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5>${response.titulo || 'Sin t√≠tulo'}</h5>
                                        <p class="text-muted">${response.descripcion || 'Sin descripci√≥n'}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title">Informaci√≥n</h6>
                                                <ul class="list-unstyled mb-0">
                                                    <li class="mb-2">
                                                        <strong>Folio:</strong><br>
                                                        <code>${response.quejaId || 'N/A'}</code>
                                                    </li>
                                                    <li class="mb-2">
                                                        <strong>Estado:</strong><br>
                                                        <span class="badge-estado ${estadoClass}">${estadoText}</span>
                                                    </li>
                                                    <li class="mb-2">
                                                        <strong>Comercio:</strong><br>
                                                        ${response.comercio || 'N/A'}
                                                    </li>
                                                    <li class="mb-2">
                                                        <strong>Fecha:</strong><br>
                                                        ${fecha}
                                                    </li>
                                                    <li>
                                                        <strong>Usuario:</strong><br>
                                                        ${response.usuario || 'N/A'}
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6>Historial</h6>
                                    <div class="timeline">
                                        <div class="timeline-item">
                                            <div class="timeline-marker"></div>
                                            <div class="timeline-content">
                                                <h6>Queja Registrada</h6>
                                                <small class="text-muted">${fecha}</small>
                                                <p>La queja ha sido registrada en el sistema y est√° pendiente de revisi√≥n.</p>
                                            </div>
                                        </div>
                                        ${response.estado === 'EN_PROCESO' ? `
                                        <div class="timeline-item">
                                            <div class="timeline-marker"></div>
                                            <div class="timeline-content">
                                                <h6>En Revisi√≥n</h6>
                                                <small class="text-muted">${new Date().toLocaleDateString()}</small>
                                                <p>La queja est√° siendo revisada por el personal de PROFECO.</p>
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${response.estado === 'RESUELTA' ? `
                                        <div class="timeline-item">
                                            <div class="timeline-marker"></div>
                                            <div class="timeline-content">
                                                <h6>Resuelta</h6>
                                                <small class="text-muted">${new Date().toLocaleDateString()}</small>
                                                <p>La queja ha sido resuelta satisfactoriamente.</p>
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;

                                            const modal = new bootstrap.Modal(document.getElementById('quejaModal'));
                                            modal.show();
                                        }
                                    } catch (error) {
                                        console.error('Error al cargar detalles:', error);
                                        mostrarError('No se pudieron cargar los detalles de la queja.');
                                    }
                                }

                                function actualizarEstadisticas() {
                                    // Contar por estado
                                    const counts = {
                                        RECIBIDA: 0,
                                        EN_PROCESO: 0,
                                        RESUELTA: 0,
                                        CERRADA: 0
                                    };

                                    const comercios = new Set();

                                    todasLasQuejas.forEach(queja => {
                                        counts[queja.estado] = (counts[queja.estado] || 0) + 1;
                                        if (queja.comercio) {
                                            comercios.add(queja.comercio);
                                        }
                                    });

                                    // Actualizar contadores de estado
                                    document.getElementById('count-recibida').textContent = counts.RECIBIDA || 0;
                                    document.getElementById('count-proceso').textContent = counts.EN_PROCESO || 0;
                                    document.getElementById('count-resuelta').textContent = counts.RESUELTA || 0;
                                    document.getElementById('count-cerrada').textContent = counts.CERRADA || 0;

                                    // Actualizar lista de comercios
                                    const comerciosList = document.getElementById('comercios-list');
                                    comerciosList.innerHTML = '';

                                    Array.from(comercios).forEach(comercio => {
                                        const count = todasLasQuejas.filter(q => q.comercio === comercio).length;
                                        comerciosList.innerHTML += `
                            <div class="form-check mb-2">
                                <input class="form-check-input filter-comercio" type="radio" 
                                       name="comercioFilter" id="comercio-${comercio}" 
                                       value="${comercio}" onchange="filtrarPorComercio('${comercio}')">
                                <label class="form-check-label" for="comercio-${comercio}">
                                    ${comercio} <span class="badge bg-light text-dark">${count}</span>
                                </label>
                            </div>
                        `;
                                    });

                                    // Actualizar estad√≠sticas generales
                                    const total = todasLasQuejas.length;
                                    const resueltas = counts.RESUELTA || 0;
                                    const porcentajeResolucion = total > 0 ? Math.round((resueltas / total) * 100) : 0;

                                    document.getElementById('total-quejas').textContent = total;
                                    document.getElementById('resolucion-progress').style.width = `${porcentajeResolucion}%`;
                                    document.getElementById('resolucion-text').textContent = `${porcentajeResolucion}% resueltas`;

                                    // Actualizar summary
                                    const summary = document.getElementById('quejas-summary');
                                    if (total === 0) {
                                        summary.textContent = 'No tienes quejas registradas';
                                    } else {
                                        const pendientes = counts.RECIBIDA + counts.EN_PROCESO;
                                        summary.textContent =
                                                `${total} queja${total !== 1 ? 's' : ''} ‚Ä¢ ${pendientes} pendiente${pendientes !== 1 ? 's' : ''}`;
                                    }
                                }

                                function actualizarContadores() {
                                    // Actualizar contador de resultados
                                    const totalFiltradas = quejasFiltradas.length;
                                    document.getElementById('result-count').textContent =
                                            `${totalFiltradas} queja${totalFiltradas !== 1 ? 's' : ''}`;
                                }

                                function filtrarPorComercio(comercio) {
                                    if (filtrosActivos.comercio === comercio) {
                                        filtrosActivos.comercio = null;
                                    } else {
                                        filtrosActivos.comercio = comercio;
                                    }
                                    aplicarFiltros();
                                }

                                function descargarReporte() {
                                    if (quejasFiltradas.length === 0) {
                                        mostrarError('No hay quejas para generar reporte');
                                        return;
                                    }

                                    // Crear contenido CSV
                                    let csv = 'Folio,T√≠tulo,Comercio,Estado,Fecha,Descripci√≥n\n';

                                    quejasFiltradas.forEach(queja => {
                                        const fecha = new Date(queja.fecha).toLocaleDateString();
                                        const descripcion = (queja.descripcion || '').replace(/"/g, '""').replace(/\n/g, ' ');

                                        csv += `"${queja.quejaId || ''}","${queja.titulo || ''}","${queja.comercio || ''}",`;
                                        csv += `"${queja.estado || ''}","${fecha}","${descripcion}"\n`;
                                    });

                                    // Crear y descargar archivo
                                    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                                    const link = document.createElement('a');
                                    const url = URL.createObjectURL(blob);
                                    link.setAttribute('href', url);
                                    link.setAttribute('download', `reporte-quejas-${new Date().toISOString().split('T')[0]}.csv`);
                                    link.style.visibility = 'hidden';
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);

                                    mostrarExito('Reporte descargado exitosamente');
                                }

                                function mostrarLoading(mostrar) {
                                    document.getElementById('loading').style.display = mostrar ? 'block' : 'none';
                                }

                                function mostrarError(mensaje) {
                                    mostrarAlerta(mensaje, 'danger');
                                }

                                function mostrarExito(mensaje) {
                                    mostrarAlerta(mensaje, 'success');
                                }

                                function mostrarAlerta(mensaje, tipo) {
                                    const alertContainer = document.getElementById('alert-container');
                                    const alertId = 'alert-' + Date.now();

                                    alertContainer.innerHTML = `
                        <div id="${alertId}" class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                            ${mensaje}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;

                                    // Auto-eliminar despu√©s de 5 segundos
                                    setTimeout(() => {
                                        const alert = document.getElementById(alertId);
                                        if (alert) {
                                            const bsAlert = new bootstrap.Alert(alert);
                                            bsAlert.close();
                                        }
                                    }, 5000);
                                }

                                // Funciones auxiliares
                                function getEstadoClass(estado) {
                                    switch (estado?.toUpperCase()) {
                                        case 'RECIBIDA':
                                            return 'badge-recibida';
                                        case 'EN_PROCESO':
                                            return 'badge-en-proceso';
                                        case 'RESUELTA':
                                            return 'badge-resuelta';
                                        case 'CERRADA':
                                            return 'badge-cerrada';
                                        default:
                                            return 'badge-cerrada';
                                    }
                                }

                                function getEstadoText(estado) {
                                    switch (estado?.toUpperCase()) {
                                        case 'RECIBIDA':
                                            return 'Recibida';
                                        case 'EN_PROCESO':
                                            return 'En Proceso';
                                        case 'RESUELTA':
                                            return 'Resuelta';
                                        case 'CERRADA':
                                            return 'Cerrada';
                                        default:
                                            return estado || 'Desconocido';
                                    }
                                }

                                function esMismoDia(fecha1, fecha2) {
                                    return fecha1.getDate() === fecha2.getDate() &&
                                            fecha1.getMonth() === fecha2.getMonth() &&
                                            fecha1.getFullYear() === fecha2.getFullYear();
                                }

                                function esMismaSemana(fecha1, fecha2) {
                                    const unDia = 24 * 60 * 60 * 1000;
                                    const diffDias = Math.round(Math.abs((fecha1 - fecha2) / unDia));
                                    return diffDias <= 7;
                                }

                                // Exportar funciones al scope global
                                window.cambiarPagina = cambiarPagina;
                                window.filtrarPorComercio = filtrarPorComercio;
                                window.seguimientoQueja = function (quejaId) {
                                    alert(`Seguimiento para queja ${quejaId}\n\nEsta funcionalidad estar√° disponible pronto.`);
                                };
                                window.imprimirQueja = function () {
                                    window.print();
                                };
                            });

                            function logout() {
                                if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
                                    window.authService.logout();
                                }
                            }
        </script>
    </body>
</html>